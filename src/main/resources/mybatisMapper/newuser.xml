<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bonc.dw3.mapper.NewuserMapper">

    <!--1.地域接口 :全国所有省份数据显示-->
    <select id="getProv" resultType="java.util.HashMap">
        select p.PROV_ID, p.PRO_NAME
        from v_dmcode_province p
        order by p.prov_id
    </select>

    <!--2.筛选条件-->
    <select id="selectCondition" resultType="java.util.Map">
        select t.dimension_type_code t_id,n.dimension_code data_id,t.dimension_type_name t_name ,n.dimension_name data_text
        from dw_newuser_dimension_type t,dw_newuser_dimension_name n
        where t.dimension_type_code=n.dimension_type_code
        order by t.dimension_type_code,n.dimension_code
    </select>

    <!--3.入网月最大最小账期-->
    <select id="getMinMaxDateEntry" resultType="java.util.Map">
        select distinct to_char(to_date(min(t.acct_date), 'yyyymm'), 'yyyy-mm') min_date,
                        to_char(to_date(max(t.acct_date), 'yyyymm'), 'yyyy-mm') max_date
        from dw_newuser_acct_entry_month t
    </select>

    <!--4.观察月最大最小账期-->
    <select id="getMinMaxDateView" resultType="java.util.Map">
        select distinct to_char(to_date(min(t.acct_date), 'yyyymm'), 'yyyy-mm') min_date,
                        to_char(to_date(max(t.acct_date), 'yyyymm'), 'yyyy-mm') max_date
        from dw_newuser_acct_view_month t
    </select>

    <!--5.指标列表-->
    <select id="getKpiList" resultType="java.util.Map">
        select t.kpi_code,t.kpi_name from dw_newuser_kpi t order by t.kpi_code
    </select>

    <!--6.表格数据-->
    <select id="getDataTable" resultType="java.util.Map" parameterType="java.util.Map">

        select to_char(to_date(#{entryMonth}, 'yyyymm'), 'yyyy-mm') entry_month,
        to_char(to_date(t.acct_date, 'yyyymm'), 'yyyy-mm') view_month,
        #{kpiCode} kpi_code,
        to_char(t1.kpi_value) kpi_value
        from (select * from dw_newuser_acct_view_month
        where acct_date between #{viewStartDate} and #{viewEndDate}) t
        left join (select entry_month,
        view_month,
        t.kpi_code,
        t.kpi_value
        from dw_newuser_data t
        where 1=1
        <if test="provId != null">
            and t.prov_id in
            <foreach collection="provId" item="provId" index="index" open="(" close=")" separator=",">
                #{provId}
            </foreach>
        </if>
        <if test="clientId != null">
            and client_type in
            <foreach collection="clientId" item="clientId" index="index" open="(" close=")" separator=",">
                #{clientId}
            </foreach>
        </if>
        <if test="channel != null">
            and channel_type in
            <foreach collection="channel" item="channelId" index="index" open="(" close=")" separator=",">
                #{channelId}
            </foreach>
        </if>
        <if test="contract != null">
            and contract_type in
            <foreach collection="contract" item="contractId" index="index" open="(" close=")" separator=",">
                #{contractId}
            </foreach>
        </if>
        <if test="network != null">
            and network_use in
            <foreach collection="network" item="networkId" index="index" open="(" close=")" separator=",">
                #{networkId}
            </foreach>
        </if>
        <if test="terminal != null">
            and device_type in
            <foreach collection="terminal" item="terminalId" index="index" open="(" close=")" separator=",">
                #{terminalId}
            </foreach>
        </if>
        <if test="income != null">
            and income_level in
            <foreach collection="income" item="incomeId" index="index" open="(" close=")" separator=",">
                #{incomeId}
            </foreach>
        </if>
        <if test="product != null">
            and product_type in
            <foreach collection="product" item="productId" index="index" open="(" close=")" separator=",">
                #{productId}
            </foreach>
        </if>
        and entry_month = #{entryMonth}
        and kpi_code = #{kpiCode}
        order by entry_month, view_month) t1
        on t.acct_date = t1.view_month
        order by t.ord
    </select>

    <!--7.得到入网月列表-->
    <select id="getEntryDateList" resultType="java.util.HashMap" parameterType="java.util.Map">
        select substr(acct_date,0,4) entry_year,
               substr(acct_date,5,6) entry_month
        from dw_newuser_acct_entry_month
        where acct_date between #{entryStartDate} and #{entryEndDate}
        order by entry_year,entry_month
    </select>

    <!--8.得到观察月列表-->
    <select id="getViewDateList" resultType="java.util.HashMap" parameterType="java.util.Map">
        select substr(acct_date,0,4) view_year,
               substr(acct_date,5,6) view_month
        from dw_newuser_acct_view_month
        where acct_date between #{viewStartDate} and #{viewEndDate}
        order by view_year,view_month
    </select>

    <!--9.得到新发展用户数据-->
    <select id="getNewUserNum" resultType="java.lang.String" parameterType="java.util.Map">
        select to_char(sum(t.kpi_value)) kpi_value
        from dw_newuser_data t
        where 1=1
        <if test="provId != null">
            and t.prov_id in
            <foreach collection="provId" item="provId" index="index" open="(" close=")" separator=",">
                #{provId}
            </foreach>
        </if>
        <if test="clientId != null">
            and client_type in
            <foreach collection="clientId" item="clientId" index="index" open="(" close=")" separator=",">
                #{clientId}
            </foreach>
        </if>
        <if test="channel != null">
            and channel_type in
            <foreach collection="channel" item="channelId" index="index" open="(" close=")" separator=",">
                #{channelId}
            </foreach>
        </if>
        <if test="contract != null">
            and contract_type in
            <foreach collection="contract" item="contractId" index="index" open="(" close=")" separator=",">
                #{contractId}
            </foreach>
        </if>
        <if test="network != null">
            and network_use in
            <foreach collection="network" item="networkId" index="index" open="(" close=")" separator=",">
                #{networkId}
            </foreach>
        </if>
        <if test="terminal != null">
            and device_type in
            <foreach collection="terminal" item="terminalId" index="index" open="(" close=")" separator=",">
                #{terminalId}
            </foreach>
        </if>
        <if test="income != null">
            and income_level in
            <foreach collection="income" item="incomeId" index="index" open="(" close=")" separator=",">
                #{incomeId}
            </foreach>
        </if>
        <if test="product != null">
            and product_type in
            <foreach collection="product" item="productId" index="index" open="(" close=")" separator=",">
                #{productId}
            </foreach>
        </if>
        and entry_month = #{entryMonth}
        and kpi_code = 'CKP_25107'
    </select>

    <!--10.得到kpi_name-->
    <select id="getKpiName" resultType="java.lang.String" parameterType="java.lang.String">
        select kpi_name
        from dw_newuser_kpi
        where kpi_code = #{kpiCode}
    </select>












</mapper>